#!/bin/bash

# --- Configuration ---
readonly MAIN_SCRIPT_NAME="ftscript"
readonly SCRIPT_DIR=$(cd "$(dirname "$(realpath "${BASH_SOURCE[0]}")")" && pwd)
readonly SYMLINK_SUBDIR=".ftscript_links"
readonly COMMAND_DIR="${SCRIPT_DIR}/${SYMLINK_SUBDIR}"
readonly VALID_COMMANDS=("test" "build" "clean")
DEBUG=true  # Set to false to disable debug output

# --- Debug Function ---
debug() {
    [[ "$DEBUG" == true ]] && echo "[DEBUG] $1" >&2
}

# --- Command Implementations ---
ftscript_test() {
    debug "Running test suite"
    echo "Running test suite"
}

ftscript_build() {
    debug "Building project"
    echo "Building project"
}

ftscript_clean() {
    debug "Cleaning build artifacts"
    echo "Cleaning build artifacts"
}

# --- Command Validation ---
is_valid_command() {
    local cmd="$1"
    debug "Validating command: $cmd"
    for valid_cmd in "${VALID_COMMANDS[@]}"; do
        [[ "$valid_cmd" == "$cmd" ]] && return 0
    done
    return 1
}

# --- Symlink Setup ---
setup_command_links() {
    debug "Setting up command symlinks in $COMMAND_DIR"
    mkdir -p "$COMMAND_DIR" || return 1
    
    local created=0
    for cmd in "${VALID_COMMANDS[@]}"; do
        local link_path="${COMMAND_DIR}/ft${cmd}"
        if [[ ! -e "$link_path" ]]; then
            debug "Creating symlink: $link_path -> ${SCRIPT_DIR}/${MAIN_SCRIPT_NAME}"
            ln -sf "${SCRIPT_DIR}/${MAIN_SCRIPT_NAME}" "$link_path" && ((created++))
        fi
    done

    (( created == 0 )) && echo "Symlinks already there"
    (( created > 0 )) && echo "Created ${created} command symlinks"
    return 0
}

# --- Main Dispatcher ---
dispatch_command() {
    local invoked_as="$(basename "$0")"
    local command_name
    
    debug "Invoked as: $invoked_as with args: $*"
    
    if [[ "$invoked_as" == "$MAIN_SCRIPT_NAME" ]]; then
        # Called directly: ./ftscript <command>
        [[ $# -eq 0 ]] && { setup_command_links; return $?; }
        command_name="$1"
    else
        # Called via symlink: ft<command>
        command_name="${invoked_as#ft}"
    fi

    if is_valid_command "$command_name"; then
        debug "Dispatching to: ftscript_${command_name} with args: ${@:2}"
        "ftscript_${command_name}" "${@:2}"
    else
        debug "Invalid command attempt: $command_name"
        echo "Error: Unknown command '${command_name}'" >&2
        echo "Available commands: ft${VALID_COMMANDS[*]/#/|ft}" | sed 's/|/, /g' >&2
        return 1
    fi
}

# --- Runtime Handler ---
if [[ "$0" == "$BASH_SOURCE" ]]; then
    debug "Direct execution detected"
    dispatch_command "$@"
else
    debug "Script being sourced"
    if [[ -d "$COMMAND_DIR" ]]; then
        if [[ ":$PATH:" != *":$COMMAND_DIR:"* ]]; then
            debug "Adding $COMMAND_DIR to PATH"
            export PATH="${PATH}:${COMMAND_DIR}"
            echo "Command directory added to PATH"
        else
            debug "Command directory already in PATH"
        fi
    else
        debug "Command directory not found: $COMMAND_DIR"
        echo "Run ./${MAIN_SCRIPT_NAME} first to create commands" >&2
    fi
fi